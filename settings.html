<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Settings page</title>
        <link rel="icon" type="image/x-icon" href="./assets/images/favicon.svg" />
        <link rel="stylesheet" type="text/css" href="./assets/styles/bootstrap-extended.min.css">
        <link rel="stylesheet" type="text/css" href="./assets/styles/style.min.css">
        <link rel="stylesheet" type="text/css" href="./assets/styles/colors.min.css">
        <link rel="stylesheet" type="text/css" href="./assets/styles/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="./assets/styles/google-fonts.css">
        <link rel="stylesheet" type="text/css" href="./assets/styles/styles.css">
        <link rel="stylesheet" type="text/css" href="./assets/styles/bootstrap-timepicker.min.css">
    </head>
<body>
    <nav class="navbar navbar-custom primary-bg">
        <a href="./index.html" class="back-button">
            <i class="icon-arrow-left font-large-1 float-right"></i>
        </a>
    </nav>
    <div class="grey-bg container-fluid">
    <section>
        <div class="row">
            <div class="col-xl-3 col-sm-3"></div>
            <div class="col-xl-6 col-sm-6 col-12 align-self-center">
                <h3 class="mt-1">Settings</h3>
                <div id="settingsPracticeTimePanel">
                    <div class="row mb-2">
                        <div class="col-6">
                            Morning practice time
                        </div>
                        <div class="col-6">
                            <div class="input-group bootstrap-timepicker timepicker">
                                <input id="morningTimepicker" type="text" class="form-control input-small">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            Evening practice time
                        </div>
                        <div class="col-6">
                            <div class="input-group bootstrap-timepicker timepicker">
                                <input id="eveningTimepicker" type="text" class="form-control input-small">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
                <h3 class="mt-1 mb-1">Project contacts</h3>
                <div class="row mb-2">
                    <div class="col-6">
                        Contact developer
                        <p class="text-muted text-justify mb-0">
                            If you find a bug or have ideas on how to improve the product, please contact us
                        </p>
                    </div>
                    <div class="col-6">
                        <a href="https://twitter.com/nick_lipnyagov" target="_blank" onclick="gtag('event', 'settings_twitter_opened');">
                            <i class="icon-social-twitter font-large-1"></i>
                        </a>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        Donate
                        <p class="text-muted text-justify">
                            Thanks to your donations we continue supporting this app and help other people to feel more joy
                        </p>
                    </div>
                    <div class="col-6">
                        <a href="https://www.patreon.com/joypractices" target="_blank" onclick="gtag('event', 'settings_patreon_opened');">
                            <button type="button" class="btn btn-outline-primary">Patreon</button>
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-3"></div>
        </div>
    </section>
    </div>
    <script src="./assets/js/jquery.js"></script>
    <script src="./assets/js/bootstrap-timepicker.min.js"></script>
    <script type="text/javascript">
        const morningTime = window.localStorage.morningTime;
        const eveningTime = window.localStorage.eveningTime;

        if (morningTime) {
            $('#morningTimepicker').timepicker('setTime', morningTime);
        }
        if (eveningTime) {
            $('#eveningTimepicker').timepicker('setTime', eveningTime);
        }

        $('#morningTimepicker').timepicker({
          showInputs: false
        });
        $('#eveningTimepicker').timepicker({
          showInputs: false
        });

        $('#morningTimepicker').change(function() {
            // TODO: notifications with default time
            window.localStorage.morningTime = $('#morningTimepicker').val();
            createPracticeNotifications();
        });
        $('#eveningTimepicker').change(function() {
            // TODO: notifications with default time
            window.localStorage.eveningTime = $('#eveningTimepicker').val();
            createPracticeNotifications();
        });

        function createPracticeNotifications() {
            if (navigator.serviceWorker && 'Notification' in window && 'showTrigger' in Notification.prototype) {
                if (Notification.permission === "granted") {
                    navigator.serviceWorker.ready.then( registration => {
                        registration.active.postMessage('Clear notifications');
                    });

                    navigator.serviceWorker.addEventListener('message', event => {
                        const parsedMorningTime = parsePickerTime($('#morningTimepicker').val()); // Date.now()
                        setupNotification(parsedMorningTime);
                        setupNotification(parsedMorningTime + 1 * 86400000);
                        setupNotification(parsedMorningTime + 2 * 86400000);
                        setupNotification(parsedMorningTime + 3 * 86400000);

                        const parsedEveningTime = parsePickerTime($('#eveningTimepicker').val()); // Date.now()
                        setupNotification(parsedEveningTime);
                        setupNotification(parsedEveningTime + 1 * 86400000);
                        setupNotification(parsedEveningTime + 2 * 86400000);
                        setupNotification(parsedEveningTime + 3 * 86400000);
                            
                        window.localStorage.lastNotificationDate = new Date(parsedEveningTime + 3 * 86400000).toUTCString();
                    });
                } else if (Notification.permission === 'blocked') {
                    console.warn('You blocked notification permission, not possible to send notifications');
                } else {
                    Notification.requestPermission(function(status) {
                        console.log('Notification permission status:', status);
                    });
                }
            }
        }

        function setupNotification(notificationDateTime) {
            navigator.serviceWorker.getRegistration().then(function(reg) {
                const options = {
                    body: 'Practicing daily is one of the main keys to joy. It\'s time for practice!',
                    icon: './assets/images/favicon.svg',
                    showTrigger: new TimestampTrigger(notificationDateTime),
                };
                reg.showNotification(`It's time to devote a couple of minutes to yourself!`, options);
            });
        }

        // '2:30 AM', '9:00 PM' - pickerTime sample values 
        function parsePickerTime(time) {
            const timeValue = time.split(/\s/);
            const hoursAndMinutes = timeValue[0];
            const dayPart = timeValue[1];
            const hours = dayPart === 'AM' ? Number(hoursAndMinutes.split(':')[0]) : Number(hoursAndMinutes.split(':')[0]) + 12;
            const minutes = Number(hoursAndMinutes.split(':')[1]);
            
            return new Date().setHours(hours,minutes,0,0);
        }
    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H8DE1TZN5W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-H8DE1TZN5W');
    </script>
</body>
</html>